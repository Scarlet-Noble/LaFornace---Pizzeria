<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pagar - La Fornace</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="styles/global.css">
    <link rel="stylesheet" href="styles/us06-pago.css">
</head>

<body>
<div class="container py-4">
    <h2 class="mb-4">üí≥ Pago del Pedido</h2>

    <div class="card">
        <div class="card-header bg-dark text-white">
            <h5>Resumen</h5>
        </div>

        <div class="card-body">
            <div class="d-flex justify-content-between mb-2">
                <span>Subtotal:</span>
                <strong id="subtotal-text">$0</strong>
            </div>

            <div class="d-flex justify-content-between mb-2">
                <span>Env√≠o:</span>
                <strong id="envio-text">$0</strong>
            </div>

            <hr>

            <div class="d-flex justify-content-between">
                <strong>Total:</strong>
                <strong id="total-text" class="text-success">$0</strong>
            </div>

            <button id="btn-confirmar" class="btn btn-success w-100 mt-3">
                Confirmar y Pagar
            </button>
        </div>
    </div>

    <a href="us05-carrito.html" class="btn btn-outline-secondary mt-3">‚Üê Volver</a>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="scripts/api.js"></script>

<script>

function getCarrito() {
    try {
        return JSON.parse(localStorage.getItem("carrito")) || [];
    } catch {
        return [];
    }
}

function formatoCLP(v) {
    return v.toLocaleString("es-CL");
}

async function renderResumen() {
    const carrito = getCarrito();
    let subtotal = 0;

    carrito.forEach(i => {
        subtotal += i.precio * i.cantidad;
    });

    const envio = subtotal > 0 ? 2000 : 0;
    const total = subtotal + envio;

    document.getElementById("subtotal-text").textContent = "$" + formatoCLP(subtotal);
    document.getElementById("envio-text").textContent    = "$" + formatoCLP(envio);
    document.getElementById("total-text").textContent    = "$" + formatoCLP(total);
}

async function confirmarPago() {
    const usuario = getUsuario();
    const carrito = getCarrito();

    if (!usuario) {
        alert("Debes iniciar sesi√≥n.");
        window.location.href = "us02-login.html";
        return;
    }

    if (carrito.length === 0) {
        alert("Tu carrito est√° vac√≠o.");
        return;
    }

    const items = carrito.map(p => ({
        pizza_id: p.id,
        cantidad: p.cantidad
    }));

    try {
        const pedido = await crearPedido(usuario.id, items);

        localStorage.setItem("ultimo_pedido", JSON.stringify(pedido));

        localStorage.removeItem("carrito");

        window.location.href = "us07-boleta.html";

    } catch (err) {
        console.error(err);
        alert("No se pudo procesar el pago.");
    }
}

document.addEventListener("DOMContentLoaded", () => {
    renderResumen();
    document.getElementById("btn-confirmar").onclick = confirmarPago;
});
</script>

</body>
</html>
