<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Seguimiento del Pedido - La Fornace</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="styles/global.css">

    <style>
        .estado-box {
            padding: 10px;
            border-radius: 8px;
            background: #f8f9fa;
            border: 1px solid #ddd;
        }
        .progress-step {
            font-size: 0.85rem;
        }
    </style>
</head>

<body>

<div class="container py-4">

    <h2 class="mb-4">üìç Seguimiento de Pedido</h2>

    <div class="card mb-4">
        <div class="card-body">
            <form id="form-buscar">
                <label class="form-label">C√≥digo de Seguimiento</label>
                <div class="input-group">
                    <input type="text" id="codigo" class="form-control" placeholder="Ej: LF-A1B2C3D4" required>
                    <button class="btn btn-primary" type="submit">Buscar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="resultado"></div>

    <a href="index.html" class="btn btn-outline-secondary mt-3">Volver</a>
</div>

<script src="scripts/api.js"></script>

<script>
const ESTADOS = ["pagado", "preparando", "en_camino", "entregado"];

function renderProgreso(estado) {
    const idx = ESTADOS.indexOf(estado);

    let steps = "";
    ESTADOS.forEach((st, i) => {
        steps += `
            <div class="col text-center">
                <div class="progress-step ${i <= idx ? "text-success" : "text-muted"}">
                    <strong>${st.replace("_", " ").toUpperCase()}</strong>
                </div>
            </div>
        `;
    });

    const barra = `
        <div class="progress" style="height: 8px;">
            <div class="progress-bar bg-success" style="width: ${(idx + 1) * 25}%"></div>
        </div>

        <div class="row mt-2">${steps}</div>
    `;

    return barra;
}

function renderPedido(p) {
    const cliente = p.usuario?.nombre || "Cliente";
    const direccion = p.usuario?.direccion || "Direcci√≥n no registrada";

    let itemsHTML = "<ul>";
    p.items.forEach(it => {
        const nombre = it.pizza?.nombre || "Pizza";
        itemsHTML += `<li>${nombre} x${it.cantidad} ‚Äî $${it.precio_unitario}</li>`;
    });
    itemsHTML += "</ul>";

    return `
        <div class="card">
            <div class="card-body">

                <h4 class="mb-3">Pedido #${p.id}</h4>
                
                <p><strong>Cliente:</strong> ${cliente}</p>
                <p><strong>Direcci√≥n:</strong> ${direccion}</p>
                <p><strong>C√≥digo de seguimiento:</strong> ${p.codigo_seguimiento}</p>

                <div class="mt-4 mb-4">
                    ${renderProgreso(p.estado)}
                </div>

                <h5>Detalle del pedido</h5>
                ${itemsHTML}

                <p class="mt-3"><strong>Total:</strong> $${p.total}</p>

            </div>
        </div>
    `;
}

async function buscarPedido(cod) {
    const resDiv = document.getElementById("resultado");
    resDiv.innerHTML = "<p>Buscando pedido...</p>";

    try {
        const p = await getSeguimiento(cod);

        resDiv.innerHTML = renderPedido(p);

        localStorage.setItem("lastTracking", cod);

    } catch (err) {
        resDiv.innerHTML = `
            <div class="alert alert-danger">
                Pedido no encontrado. Revisa el c√≥digo ingresado.
            </div>
        `;
    }
}

document.getElementById("form-buscar").addEventListener("submit", (e) => {
    e.preventDefault();
    const codigo = document.getElementById("codigo").value.trim().toUpperCase();
    buscarPedido(codigo);
});

setInterval(() => {
    const last = localStorage.getItem("lastTracking");
    if (last) buscarPedido(last);
}, 5000);

</script>

</body>
</html>
