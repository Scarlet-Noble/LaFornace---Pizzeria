<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Despacho - Admin</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="styles/global.css">
</head>

<body class="bg-light">

<div class="container py-4">
    <h2 class="mb-4">ðŸ“¦ Panel de Despacho (Administrador)</h2>

    <div class="card">
        <div class="card-header bg-dark text-light">
            <strong>Pedidos Recibidos</strong>
        </div>

        <div class="card-body" id="contenedor-pedidos">
            Cargando pedidos...
        </div>
    </div>

    <div class="mt-3">
        <a href="index.html" class="btn btn-outline-secondary">Volver</a>
    </div>
</div>

<script src="scripts/api.js"></script>

<script>
// =========================================
// Cargar pedidos desde backend
// =========================================
async function cargarPedidos() {
    const cont = document.getElementById("contenedor-pedidos");
    cont.innerHTML = "<p>Cargando pedidos...</p>";

    try {
        const pedidos = await apiRequest("/pedidos", "GET", null, true);

        if (!pedidos.length) {
            cont.innerHTML = "<p class='text-muted'>No hay pedidos registrados.</p>";
            return;
        }

        cont.innerHTML = "";

        pedidos.forEach(p => {
            const estado = p.estado || "desconocido";
            const cliente = p.usuario?.nombre || "Cliente desconocido";
            const direccion = p.usuario?.direccion || "Sin direcciÃ³n";

            // Detalle de items
            let detalleHTML = "";
            if (p.items?.length > 0) {
                detalleHTML = "<ul>";
                p.items.forEach(it => {
                    detalleHTML += `
                        <li>${it.pizza?.nombre || "Pizza"} x${it.cantidad}
                            â€” $${it.precio_unitario}
                        </li>`;
                });
                detalleHTML += "</ul>";
            }

            cont.innerHTML += `
                <div class="card mb-3">
                    <div class="card-body">

                        <div class="d-flex justify-content-between">
                            <div>
                                <h5>Pedido #${p.id}</h5>
                                <p class="mb-1"><strong>Cliente:</strong> ${cliente}</p>
                                <p class="mb-1"><strong>DirecciÃ³n:</strong> ${direccion}</p>
                                <p class="mb-1"><strong>Estado actual:</strong> ${estado}</p>

                                <p class="mt-3"><strong>Detalle:</strong></p>
                                ${detalleHTML}

                                <p><strong>Total:</strong> $${p.total}</p>
                                <p><strong>CÃ³digo seguimiento:</strong> ${p.codigo_seguimiento}</p>
                            </div>

                            <div class="text-end">
                                ${botonesEstado(p)}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });

    } catch (err) {
        cont.innerHTML = "<p class='text-danger'>Error cargando pedidos.</p>";
        console.error(err);
    }
}

// =========================================
// Botones dinÃ¡micos segÃºn estado del pedido
// =========================================
function botonesEstado(pedido) {

    // Flujo real:
    // pagado â†’ preparando â†’ en_camino â†’ entregado

    if (pedido.estado === "pagado") {
        return `
            <button class="btn btn-warning mb-2"
                onclick="cambiarEstado(${pedido.id}, 'preparando')">
                Marcar como PREPARANDO
            </button>
        `;
    }

    if (pedido.estado === "preparando") {
        return `
            <button class="btn btn-primary mb-2"
                onclick="cambiarEstado(${pedido.id}, 'en_camino')">
                Marcar EN CAMINO
            </button>
        `;
    }

    if (pedido.estado === "en_camino") {
        return `
            <button class="btn btn-success mb-2"
                onclick="cambiarEstado(${pedido.id}, 'entregado')">
                Marcar ENTREGADO
            </button>
        `;
    }

    if (pedido.estado === "entregado") {
        return `<span class="badge bg-success">Pedido entregado</span>`;
    }

    return `<span class="badge bg-secondary">${pedido.estado}</span>`;
}


// =========================================
// Cambiar estado
// =========================================
async function cambiarEstado(id, nuevoEstado) {
    try {
        await apiRequest(`/admin/pedidos/${id}/estado`, "PUT", {
            estado: nuevoEstado
        }, true);

        cargarPedidos();
    } catch (err) {
        alert("Error actualizando estado");
        console.error(err);
    }
}


// =========================================
// Auto refresco cada 5 segundos
// =========================================
setInterval(cargarPedidos, 5000);

document.addEventListener("DOMContentLoaded", cargarPedidos);
</script>

</body>
</html>
